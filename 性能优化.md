## H5首屏优化方案
#### 前言
随着移动设备性能不断增强，web 页面的性能体验逐渐变得可以接受，又因为 web 开发模式的诸多好处(跨平台，动态更新，减体积，无限扩展)，APP 客户端里出现越来越多内嵌 web 页面，很多 APP 把一些功能模块改成用 H5 实现。

虽然说 H5 页面性能变好了，但如果没针对性地做一些优化，体验还是很糟糕的，主要两部分体验：

* 页面启动白屏时间：打开一个 H5 页面需要做一系列处理，会有一段白屏时间，体验糟糕。
* 响应流畅度：由于 webkit 的渲染机制，单线程，历史包袱等原因，页面刷新/交互的性能体验不如原生。

#### 白屏原因
因为它做了很多事情：
`初始化webview -> 请求页面 -> 下载数据 -> 解析HTML -> 请求js/css资源 -> dom渲染 -> 解析js执行 -> JS请求数据 -> 解析渲染 -> 下载渲染图片`
一般页面在dom渲染之后能显示雏形，在这之前用户看到的都是白屏，等到下载渲染图片整个页面才完整显示，首屏秒开优化就是要减少这个过程的耗时。

#### 前端优化
* 降低请求量：合并资源，减少HTTP请求数，minify/gzip压缩，webP，lazyLoad。
* 加快请求速度：预解析DNS，减少域名数，并行加载，CDN分发。
* 缓存：HTTP协议缓存请求，离线缓存manifest，离线数据缓存localStorage。
* 渲染：js/css优化，加载顺序，服务器渲染，pipeline。

其中对首屏启动速度影响最大的就是网络请求，所以优化的重点就是缓存。（HTML的缓存，JS/CSS/Image资源的缓存，以及json数据的缓存）

总的来说，就是两种缓存：
1. 询问是否有更新：根据If-Modified-Since / ETag等协议向后端请求询问是否有更新，没有更新返回304，浏览器使用本地缓存。
2. 直接使用本地缓存：根据协议里的 Cache-Control / Expires字段去确定多长时间可以不去发请求询问更新，直接使用本地缓存。

前端能做的最大缓存策略是：
HTML文件每次都向服务器请求是否有更新
JS/CSS/Image资源文件则不请求更新，直接使用本地缓存。
JS/CSS资源更新的常见做法：在构建过程中给每个资源文件一个版本号或者hash值，若资源文件有更新，版本号和hash值变化，同时对应的HTML页面更新，变成请求新的资源URL，资源也就更新了。

json数据的缓存可以用localStorage缓存请求下来的数据，可以在首次实现时先用本地数据，再请求更新，这些都由前端JS控制。

#### 客户端优化
H5页面内嵌在客户端APP上，客户端有更多的权限，于是，客户端上可以超出浏览器的范围，做更多的优化。

`HTML缓存`
1. 在客户端拦截请求，首次请求HTML文件后缓存数据，第二次不发请求，直接使用缓存数据。
2. 什么时候请求更新？更新请求可以由客户端自由控制，可以在本地缓存打开本地页面后再在后台发起请求询问更新缓存；也可以在APP启动时，或者在某个时机在后台去发起请求预更新，提升用户访问最新代码的几率。

#### 问题
1. 没有预加载：第一次打开的体验很差，所有数据都要从网络请求。
2. 缓存不可控：缓存的存取由系统webview控制，无法控制它的缓存逻辑，带来的问题包括:
    清理逻辑不可控，缓存空间有限，可能缓存几张大图片之后，重要的JS/CSS/HTML缓存就被清除了。
    磁盘IO无法控制，无法从磁盘预加载到内存。
    更新体验差：后台HMLT/JS/CSS更新时全量下载，数据量大，弱网下载耗时长。
    无法防劫持：若HTML页面被运营商获第三方劫持，将长时间缓存劫持页面。

#### 离线包

#### 更多优化
* 公共资源包
* 预加载 webview
* 预加载数据
* Fallback
* 使用客户端接口
* 服务端渲染

## 总结
大体优化思路就是：缓存/预加载并行，缓存一切网络请求，尽量在用户打开之前就加载好所有内容，能并行的事不串行。

## 微信内访问网站被禁

申述邮箱：moment@tencent.com

[微信外部链接内容管理规范](http://weixin.qq.com/cgi-bin/readtemplate?t=weixin_external_links_content_management_specification)

[微信访问网站被限制的相关问题](http://kf.qq.com/faq/170118UnqeUZ170118mUb6fu.html)
